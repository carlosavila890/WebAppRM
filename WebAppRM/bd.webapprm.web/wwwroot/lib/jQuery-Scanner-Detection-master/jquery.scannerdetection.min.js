!function(h){h.fn.scannerDetection=function(u){if("string"==typeof u)return this.each(function(){this.scannerDetectionTest(u)}),this;if(!1===u)return this.each(function(){this.scannerDetectionOff()}),this;var e={onComplete:!1,onError:!1,onReceive:!1,onKeyDetect:!1,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,endChar:[9,13],startChar:[],ignoreIfFocusOn:!1,scanButtonKeyCode:!1,scanButtonLongPressThreshold:3,onScanButtonLongPressed:!1,stopPropagation:!1,preventDefault:!1};return"function"==typeof u&&(u={onComplete:u}),u="object"!=typeof u?h.extend({},e):h.extend({},e,u),this.each(function(){var t=this,o=h(t),r=0,n=0,i="",c=!1,s=!1,a=0,f=function(){i="",a=r=0};t.scannerDetectionOff=function(){o.unbind("keydown.scannerDetection"),o.unbind("keypress.scannerDetection")},t.isFocusOnIgnoredElement=function(){if(!u.ignoreIfFocusOn)return!1;if("string"==typeof u.ignoreIfFocusOn)return h(":focus").is(u.ignoreIfFocusOn);if("object"==typeof u.ignoreIfFocusOn&&u.ignoreIfFocusOn.length)for(var e=h(":focus"),n=0;n<u.ignoreIfFocusOn.length;n++)if(e.is(u.ignoreIfFocusOn[n]))return!0;return!1},t.scannerDetectionTest=function(e){return e&&(r=n=0,i=e),a||(a=1),i.length>=u.minLength&&n-r<i.length*u.avgTimeByChar?(u.onScanButtonLongPressed&&a>u.scanButtonLongPressThreshold?u.onScanButtonLongPressed.call(t,i,a):u.onComplete&&u.onComplete.call(t,i,a),o.trigger("scannerDetectionComplete",{string:i}),f(),!0):(u.onError&&u.onError.call(t,i),o.trigger("scannerDetectionError",{string:i}),f(),!1)},o.data("scannerDetection",{options:u}).unbind(".scannerDetection").bind("keydown.scannerDetection",function(e){if(!1!==u.scanButtonKeyCode&&e.which==u.scanButtonKeyCode)a++,e.preventDefault(),e.stopImmediatePropagation();else if(r&&-1!==u.endChar.indexOf(e.which)||!r&&-1!==u.startChar.indexOf(e.which)){var n=jQuery.Event("keypress",e);n.type="keypress.scannerDetection",o.triggerHandler(n),e.preventDefault(),e.stopImmediatePropagation()}u.onKeyDetect&&u.onKeyDetect.call(t,e),o.trigger("scannerDetectionKeyDetect",{evt:e})}).bind("keypress.scannerDetection",function(e){this.isFocusOnIgnoredElement()||(u.stopPropagation&&e.stopImmediatePropagation(),u.preventDefault&&e.preventDefault(),r&&-1!==u.endChar.indexOf(e.which)?(e.preventDefault(),e.stopImmediatePropagation(),c=!0):(r||-1===u.startChar.indexOf(e.which)?void 0!==e.which&&(i+=String.fromCharCode(e.which)):(e.preventDefault(),e.stopImmediatePropagation()),c=!1),r||(r=Date.now()),n=Date.now(),s&&clearTimeout(s),c?(t.scannerDetectionTest(),s=!1):s=setTimeout(t.scannerDetectionTest,u.timeBeforeScanTest),u.onReceive&&u.onReceive.call(t,e),o.trigger("scannerDetectionReceive",{evt:e}))})}),this}}(jQuery);